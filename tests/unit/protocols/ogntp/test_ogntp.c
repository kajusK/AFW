#include <unity.h>
#include "protocols/ogntp/encoding.c"
#include "protocols/ogntp/fcs.c"
#include "protocols/ogntp/whitening.c"
#include "utils/utils.c"
#include "protocols/encoding/manchester.c"
#include "protocols/ogntp/ogntp.c"

void test_EncodePosition(void)
{
    uint8_t buffer[OGNTP_FRAME_BYTES] = { 0 };
    const uint8_t expected[] = { 0x55, 0x55, 0x56, 0x56, 0x59, 0x59, 0xAA, 0xA5, 0x56, 0xA6, 0x6A,
        0xA5, 0x5A, 0xA5, 0x6A, 0x96, 0xA9, 0x59, 0x69, 0xA5, 0x99, 0x56, 0x65, 0x65, 0x5A, 0x6A,
        0x6A, 0x6A, 0xA5, 0x59, 0x5A, 0x66, 0x55, 0xA9, 0x55, 0xA5, 0x66, 0x65, 0x95, 0x5A, 0x56,
        0x99, 0x95, 0xA5, 0x9A, 0x95, 0x66, 0x99, 0x66, 0x6A, 0x95, 0x66 };

    ogntp_position_t position = {
        .aircraft = {
            .address = 0xddeeff,
            .addr_type = OGNTP_ADDRESS_OGN,
            .type = OGNTP_AIRCRAFT_POWERED,
        },
        .relay_cnt = 0,
        .emergency = 0,
        .latitude.num = 491951,
        .latitude.scale = 10000,
        .longitude.num = 166068,
        .longitude.scale = 10000,
        .time_s = 52,
        .gps_altitude_dm = 1236,  // 123.6 m
        .speed_dms = 128,     // 12.8 m/s
        .heading_ddeg = 3422, // 342.2 degrees
        .dop_d = 128,        // 12.8
        .is_3d_fix = true,
        .fix_quality = NMEA_FIX_DGPS,
    };

    OGNTP_EncodePosition(buffer, &position);
    TEST_ASSERT_EQUAL_UINT8_ARRAY(expected, buffer, sizeof(buffer));
}

void test_DecodePosition(void)
{
    const uint8_t data[] = { 0x55, 0x55, 0x56, 0x56, 0x59, 0x59, 0xAA, 0xA5, 0x56, 0xA6, 0x6A, 0xA5,
        0x5A, 0xA5, 0x6A, 0x96, 0xA9, 0x59, 0x69, 0xA5, 0x99, 0x56, 0x65, 0x65, 0x5A, 0x6A, 0x6A,
        0x6A, 0xA5, 0x59, 0x5A, 0x66, 0x55, 0xA9, 0x55, 0xA5, 0x66, 0x65, 0x95, 0x5A, 0x56, 0x99,
        0x95, 0xA5, 0x9A, 0x95, 0x66, 0x99, 0x66, 0x6A, 0x95, 0x66 };
    ogntp_position_t position = { 0 };

    TEST_ASSERT_TRUE(OGNTP_DecodePosition(data, &position));

    TEST_ASSERT_EQUAL_UINT32(0xddeeff, position.aircraft.address);
    TEST_ASSERT_EQUAL(OGNTP_ADDRESS_OGN, position.aircraft.addr_type);
    TEST_ASSERT_EQUAL(OGNTP_AIRCRAFT_POWERED, position.aircraft.type);
    TEST_ASSERT_EQUAL(0, position.relay_cnt);
    TEST_ASSERT_EQUAL(0, position.emergency);
    TEST_ASSERT_EQUAL(491951, position.latitude.num);
    TEST_ASSERT_EQUAL(10000, position.latitude.scale);
    TEST_ASSERT_EQUAL(166068, position.longitude.num);
    TEST_ASSERT_EQUAL(10000, position.longitude.scale);
    TEST_ASSERT_EQUAL(52, position.time_s);
    TEST_ASSERT_EQUAL(1240, position.gps_altitude_dm);
    TEST_ASSERT_EQUAL(128, position.speed_dms);
    TEST_ASSERT_EQUAL(3420, position.heading_ddeg);
    TEST_ASSERT_EQUAL(126, position.dop_d);
    TEST_ASSERT_EQUAL(true, position.is_3d_fix);
    TEST_ASSERT_EQUAL(NMEA_FIX_DGPS, position.fix_quality);
}

void test_DecodeInvalidManchester(void)
{
    const uint8_t data[] = { 0x55, 0x55, 0x56, 0x56, 0x59, 0x59, 0xAA, 0xA5, 0x56, 0xA6, 0x6A, 0xA5,
        0x5A, 0xA5, 0x6A, 0x96, 0xA9, 0x59, 0x69, 0xA5, 0x99, 0x56, 0x65, 0x65, 0x5A, 0x6A, 0x6A,
        0x6A, 0xA5, 0x59, 0x5A, 0x66, 0x55, 0xA9, 0x55, 0xA5, 0x66, 0x65, 0x95, 0x5A, 0x56, 0x99,
        0x95, 0xA5, 0x9A, 0x95, 0x66, 0x99, 0x66, 0x6A, 0x95, 0x67 };
    ogntp_position_t position = { 0 };

    TEST_ASSERT_FALSE(OGNTP_DecodePosition(data, &position));
}

void test_DecodeInvalidFCS(void)
{
    const uint8_t data[] = { 0x55, 0x55, 0x56, 0x56, 0x59, 0x59, 0xAA, 0xA5, 0x56, 0xA6, 0x6A, 0xA5,
        0x5A, 0xA5, 0x6A, 0x96, 0xA9, 0x59, 0x69, 0xA5, 0x99, 0x56, 0x65, 0x65, 0x5A, 0x6A, 0x6A,
        0x6A, 0xA5, 0x59, 0x5A, 0x66, 0x55, 0xA9, 0x55, 0xA5, 0x66, 0x65, 0x95, 0x5A, 0x56, 0x99,
        0x95, 0xA5, 0x9A, 0x95, 0x66, 0x99, 0x66, 0x6A, 0x66, 0x66 };
    ogntp_position_t position = { 0 };

    TEST_ASSERT_FALSE(OGNTP_DecodePosition(data, &position));
}
